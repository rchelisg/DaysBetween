<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <title>Days Between</title>

  <!-- PWA + iOS Safari -->
  <meta name="mobile-web-app-capable"                content="yes" />
  <meta name="apple-mobile-web-app-capable"          content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title"            content="Days Between" />
  <meta name="theme-color" content="#e0e7ff" media="(prefers-color-scheme: light)" />
  <meta name="theme-color" content="#1e1b4b" media="(prefers-color-scheme: dark)" />
  <meta name="description" content="Calculate the number of days between two dates." />

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />

  <!-- Inline SVG icon for iOS "Add to Home Screen" -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='42' fill='%234f46e5'/%3E%3Crect x='38' y='58' width='116' height='100' rx='10' fill='white'/%3E%3Crect x='38' y='58' width='116' height='36' rx='10' fill='%233730a3'/%3E%3Ccircle cx='72' cy='52' r='10' fill='%233730a3'/%3E%3Ccircle cx='72' cy='52' r='5' fill='white'/%3E%3Ccircle cx='120' cy='52' r='10' fill='%233730a3'/%3E%3Ccircle cx='120' cy='52' r='5' fill='white'/%3E%3Ctext x='96' y='84' font-family='Arial' font-weight='bold' font-size='22' fill='white' text-anchor='middle'%3E1%3C/text%3E%3Ccircle cx='68' cy='118' r='7' fill='%23c7c7cc'/%3E%3Ccircle cx='96' cy='118' r='7' fill='%234f46e5'/%3E%3Ccircle cx='124' cy='118' r='7' fill='%23c7c7cc'/%3E%3Ccircle cx='68' cy='142' r='7' fill='%23c7c7cc'/%3E%3Ccircle cx='96' cy='142' r='7' fill='%23c7c7cc'/%3E%3Ccircle cx='124' cy='142' r='7' fill='%23c7c7cc'/%3E%3C/svg%3E" />

  <style>
/* ─── Reset & Base ─────────────────────────────────────────── */
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  -webkit-tap-highlight-color: transparent;
}

:root {
  --bg-from:   #e0e7ff;
  --bg-to:     #bae6fd;
  --title-color: #1e1b4b;
  --card:      rgba(255, 255, 255, 0.92);
  --label:     #1e1b4b;
  --secondary: #6b7280;
  --accent:    #4f46e5;
  --accent2:   #0ea5e9;
  --green:     #10b981;
  --orange:    #f59e0b;
  --combined:  #7c3aed;
  --separator: rgba(79, 70, 229, 0.12);
  --radius-lg: 20px;
  --radius-md: 12px;
  --font:      -apple-system, BlinkMacSystemFont, 'SF Pro Display',
               'Helvetica Neue', Arial, sans-serif;
  --result-value-size: clamp(40px, 12vw, 56px);
  --result-unit-size:  clamp(13px, 3.8vw, 18px);
}

html, body { height: 100%; overflow: hidden; }

body {
  font-family: var(--font);
  background: linear-gradient(150deg, var(--bg-from) 0%, var(--bg-to) 100%);
  background-attachment: fixed;
  transition: background 0.5s ease;
  color: var(--label);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-top:    env(safe-area-inset-top,    20px);
  padding-bottom: env(safe-area-inset-bottom, 8px);
  padding-left:   env(safe-area-inset-left,   0px);
  padding-right:  env(safe-area-inset-right,  0px);
}

.app-wrapper {
  min-height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 0 clamp(12px, 4vw, 20px) clamp(8px, 2vh, 16px);
}

/* ─── Navigation Bar ────────────────────────────────────────── */
.nav-bar {
  width: 100%;
  max-width: 460px;
  display: flex;
  align-items: center;
  justify-content: center;
  height: clamp(56px, 15vw, 72px);
  margin-top:    clamp(6px, 2vh, 16px);
  margin-bottom: clamp(4px, 1vh, 10px);
  flex-shrink: 0;
}

.nav-title {
  font-size: clamp(26px, 7.5vw, 36px);
  font-weight: 800;
  letter-spacing: -1px;
  color: var(--title-color);
  text-shadow: 0 1px 6px rgba(0, 0, 0, 0.10);
  cursor: pointer;
  user-select: none;
  transition: color 0.5s ease, opacity 0.1s ease;
}
.nav-title:active { opacity: 0.7; }

/* ─── Date Card ─────────────────────────────────────────────── */
.card {
  width: 100%;
  max-width: 460px;
  background: var(--card);
  border-radius: var(--radius-lg);
  overflow: hidden;
  box-shadow: 0 4px 24px rgba(79,70,229,0.18), 0 1px 4px rgba(0,0,0,0.08);
  margin-top: clamp(8px, 2vh, 14px);
  flex-shrink: 0;
  border-top: 3px solid var(--accent);
}

.date-row {
  display: flex;
  align-items: center;
  padding: 0 16px;
  height: 56px;
  position: relative;
  gap: 8px;
  cursor: pointer;
  user-select: none;
}
.date-row + .date-row::before {
  content: '';
  position: absolute;
  top: 0; left: 16px; right: 0;
  height: 0.5px;
  background: var(--separator);
}
.date-row label {
  font-size: 17px;
  font-weight: 600;
  color: var(--accent);
  flex: 0 0 52px;
  user-select: none;
  pointer-events: none;
}
.date-display {
  flex: 1;
  font-size: 17px;
  color: var(--label);
  text-align: right;
  user-select: none;
  pointer-events: none;
}
.date-display.placeholder {
  color: var(--secondary);
}

/* ─── Direction Badge ───────────────────────────────────────── */
.direction-badge {
  font-size: 13px;
  color: rgba(0, 0, 0, 0.4);
  margin-top: clamp(6px, 1.5vh, 12px);
  text-align: center;
  min-height: 18px;
  flex-shrink: 0;
}
.direction-badge.warning  { color: #b45309; }
.direction-badge.same-day { color: var(--accent); }

/* ─── Result Section ────────────────────────────────────────── */
.result-section {
  width: 100%;
  max-width: 460px;
  margin-top: clamp(6px, 1.5vh, 16px);
  display: flex;
  flex-direction: column;
  background: var(--card);
  border-radius: var(--radius-lg);
  box-shadow: 0 4px 24px rgba(79,70,229,0.18), 0 1px 4px rgba(0,0,0,0.08);
  overflow: hidden;
  flex-shrink: 0;
}

.result-section.empty .result-value,
.result-section.empty .result-combined { opacity: 0.28; }

/* ─── Result Rows ───────────────────────────────────────────── */
.result-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  height: clamp(52px, 14vw, 68px);
  position: relative;
}
.result-row + .result-row::before {
  content: '';
  position: absolute;
  top: 0; left: 20px; right: 0;
  height: 0.5px;
  background: var(--separator);
}

#row-days     { border-left: 4px solid var(--accent2); }
#row-years    { border-left: 4px solid var(--green);   }
#row-months   { border-left: 4px solid var(--orange);  }
#row-combined { border-left: 4px solid var(--combined);}

.result-unit {
  font-size: var(--result-unit-size);
  font-weight: 600;
  color: #111111;
  flex-shrink: 0;
  min-width: clamp(64px, 18vw, 90px);
}

.result-value {
  font-size: var(--result-value-size);
  font-weight: 700;
  color: #111111;
  line-height: 1;
  letter-spacing: -0.03em;
  font-variant-numeric: tabular-nums;
  text-align: right;
  transition: font-size 0.15s ease;
  white-space: nowrap;
  overflow: hidden;
}

/* ─── Combined Row ──────────────────────────────────────────── */
.result-row-combined {
  justify-content: center;
  background: rgba(0, 0, 0, 0.03);
}
.result-combined {
  font-size: clamp(15px, 4.2vw, 20px);
  font-weight: 700;
  color: #111111;
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
  transition: font-size 0.15s ease;
  letter-spacing: -0.3px;
}

/* ─── Action Buttons ────────────────────────────────────────── */
.action-row {
  width: 100%;
  max-width: 460px;
  display: flex;
  gap: 10px;
  margin-top: clamp(8px, 2vh, 14px);
  flex-shrink: 0;
}
.action-btn {
  flex: 1;
  border: none;
  border-radius: var(--radius-md);
  height: clamp(44px, 12vw, 52px);
  font-family: var(--font);
  font-size: clamp(15px, 4vw, 17px);
  font-weight: 600;
  cursor: pointer;
  transition: opacity 0.15s ease, transform 0.1s ease, background 0.5s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
}
#swap-btn, #copy-btn { color: #ffffff; }
.action-btn:active, .action-btn.pressed { opacity: 0.82; transform: scale(0.97); }
.action-btn.copied { background: #10b981 !important; }
.btn-icon { font-size: 18px; line-height: 1; }

/* ─── Footer ────────────────────────────────────────────────── */
.app-footer {
  margin-top: auto;
  padding-top: clamp(6px, 1.5vh, 12px);
  font-size: clamp(10px, 2.8vw, 13px);
  color: rgba(0, 0, 0, 0.35);
  text-align: center;
  flex-shrink: 0;
  user-select: none;
}

/* ─── Custom Calendar Picker ────────────────────────────────── */
#cal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 200;
  background: rgba(0, 0, 0, 0.35);
  -webkit-backdrop-filter: blur(4px);
  backdrop-filter: blur(4px);
  align-items: flex-end;   /* sheet slides up from bottom */
  justify-content: center;
}
#cal-overlay.visible { display: flex; }

#cal-sheet {
  width: 100%;
  max-width: 460px;
  background: #ffffff;
  border-radius: 24px 24px 0 0;
  padding-bottom: env(safe-area-inset-bottom, 12px);
  box-shadow: 0 -4px 32px rgba(0,0,0,0.18);
  overflow: hidden;
}

/* Header row: prev / title / next */
#cal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 16px 8px;
  border-bottom: 0.5px solid rgba(0,0,0,0.08);
}
.cal-nav-btn {
  width: 36px; height: 36px;
  border: none;
  background: rgba(0,0,0,0.06);
  border-radius: 50%;
  font-size: 18px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.cal-nav-btn:active { background: rgba(0,0,0,0.14); }

#cal-month-label {
  font-size: 17px;
  font-weight: 700;
  color: var(--accent);
  cursor: pointer;
  user-select: none;
  padding: 4px 10px;
  border-radius: 8px;
  transition: background 0.15s;
  flex: 1;
  text-align: center;
}
#cal-month-label:active { background: rgba(0,0,0,0.06); }

/* Weekday row */
#cal-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  padding: 6px 10px 2px;
}
.cal-wd {
  text-align: center;
  font-size: 12px;
  font-weight: 600;
  color: #999;
  padding: 4px 0;
}

/* Day grid */
#cal-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  padding: 0 10px 10px;
  gap: 2px;
}
.cal-day {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: clamp(14px, 4vw, 17px);
  font-weight: 500;
  border-radius: 50%;
  cursor: pointer;
  transition: background 0.12s, color 0.12s;
  user-select: none;
}
.cal-day:active        { background: rgba(0,0,0,0.08); }
.cal-day.other-month   { color: #ccc; }
.cal-day.today         { border: 2px solid var(--accent); font-weight: 700; }
.cal-day.selected      { background: var(--accent); color: #fff !important; border: none; }
.cal-day.today.selected { background: var(--accent); border: none; }

/* Year picker panel (shown instead of grid when tapping month label) */
#cal-year-panel {
  display: none;
  flex-direction: column;
  max-height: 260px;
  overflow-y: auto;
  padding: 8px 10px 10px;
  -webkit-overflow-scrolling: touch;
}
#cal-year-panel.visible { display: flex; }
.cal-year-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
  margin-bottom: 6px;
}
.cal-year-btn {
  border: none;
  background: rgba(0,0,0,0.05);
  border-radius: 10px;
  padding: 8px 2px;
  font-size: clamp(13px, 3.6vw, 16px);
  font-weight: 500;
  cursor: pointer;
  text-align: center;
  transition: background 0.12s;
}
.cal-year-btn:active   { background: rgba(0,0,0,0.12); }
.cal-year-btn.selected { background: var(--accent); color: #fff; font-weight: 700; }

/* Done / Cancel row */
#cal-actions {
  display: flex;
  gap: 10px;
  padding: 8px 16px 10px;
  border-top: 0.5px solid rgba(0,0,0,0.08);
}
.cal-action-btn {
  flex: 1;
  height: 44px;
  border: none;
  border-radius: var(--radius-md);
  font-family: var(--font);
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
}
#cal-cancel { background: rgba(0,0,0,0.07); color: #333; }
#cal-done   { background: var(--accent);    color: #fff; }
#cal-cancel:active { background: rgba(0,0,0,0.14); }
#cal-done:active   { opacity: 0.85; }

/* ─── Dark Mode ─────────────────────────────────────────────── */
@media (prefers-color-scheme: dark) {
  :root:not([style*="--bg-from"]) {
    --bg-from:     #1e1b4b;
    --bg-to:       #0c4a6e;
    --title-color: #e0e7ff;
    --card:        rgba(30, 27, 75, 0.92);
    --label:       #e0e7ff;
    --secondary:   #94a3b8;
    --accent:      #818cf8;
    --accent2:     #38bdf8;
    --green:       #34d399;
    --orange:      #fbbf24;
    --combined:    #a78bfa;
    --separator:   rgba(129, 140, 248, 0.15);
  }
  :root:not([style*="--bg-from"]) .direction-badge { color: rgba(255,255,255,0.5); }
  :root:not([style*="--bg-from"]) .app-footer      { color: rgba(255,255,255,0.35); }
}

@media (max-width: 374px) {
  :root {
    --result-value-size: clamp(32px, 10vw, 44px);
    --result-unit-size:  clamp(12px, 3.4vw, 15px);
  }
}
@media (max-height: 700px) {
  .nav-bar    { height: 44px; margin-top: 4px; }
  .date-row   { height: 48px; }
  .result-row { height: clamp(44px, 12vw, 56px); }
}
  </style>
</head>

<body>
  <div class="app-wrapper">

    <nav class="nav-bar" aria-label="Application title">
      <h1 class="nav-title">Days Between</h1>
    </nav>

    <section class="card" aria-label="Date selection">
      <div class="date-row" id="start-row" role="button" aria-label="Select start date">
        <label>Start</label>
        <span class="date-display" id="start-display">Select date</span>
      </div>
      <div class="date-row" id="end-row" role="button" aria-label="Select end date">
        <label>End</label>
        <span class="date-display" id="end-display">Select date</span>
      </div>
    </section>

    <p class="direction-badge" id="direction-badge" aria-live="polite">Select dates above</p>

    <section class="result-section empty" id="result-section"
             aria-live="polite" aria-label="Result">
      <div class="result-row" id="row-days">
        <span class="result-unit">Days</span>
        <span class="result-value" id="val-days">—</span>
      </div>
      <div class="result-row" id="row-years">
        <span class="result-unit">Years</span>
        <span class="result-value" id="val-years">—</span>
      </div>
      <div class="result-row" id="row-months">
        <span class="result-unit">Months</span>
        <span class="result-value" id="val-months">—</span>
      </div>
      <div class="result-row result-row-combined" id="row-combined">
        <span class="result-combined" id="val-combined">— Years — Months — Days</span>
      </div>
    </section>

    <div class="action-row">
      <button class="action-btn" id="swap-btn" aria-label="Swap start and end dates">
        <span class="btn-icon" aria-hidden="true">⇅</span>Swap
      </button>
      <button class="action-btn" id="copy-btn" aria-label="Copy results to clipboard">
        <span class="btn-icon" aria-hidden="true">⎘</span>
        <span id="copy-label">Copy</span>
      </button>
    </div>

    <p class="app-footer">&#169; JM 2026 &nbsp;V1.2</p>

  </div>

  <!-- ── Custom Calendar Picker ────────────────────────────────── -->
  <div id="cal-overlay" role="dialog" aria-modal="true" aria-label="Date picker">
    <div id="cal-sheet">
      <div id="cal-header">
        <button class="cal-nav-btn" id="cal-prev" aria-label="Previous month">&#8249;</button>
        <span id="cal-month-label" role="button" aria-label="Select year"></span>
        <button class="cal-nav-btn" id="cal-next" aria-label="Next month">&#8250;</button>
      </div>
      <div id="cal-weekdays">
        <span class="cal-wd">Su</span><span class="cal-wd">Mo</span>
        <span class="cal-wd">Tu</span><span class="cal-wd">We</span>
        <span class="cal-wd">Th</span><span class="cal-wd">Fr</span>
        <span class="cal-wd">Sa</span>
      </div>
      <div id="cal-grid"></div>
      <div id="cal-year-panel"></div>
      <div id="cal-actions">
        <button class="cal-action-btn" id="cal-cancel">Cancel</button>
        <button class="cal-action-btn" id="cal-done">Done</button>
      </div>
    </div>
  </div>

  <script>
    // ── Service Worker ───────────────────────────────────────────────────────
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .catch(err => console.warn('SW registration failed:', err));
      });
    }

    // ── App version ──────────────────────────────────────────────────────────
    const APP_VERSION = 'V1.2';

    // ── DOM refs ─────────────────────────────────────────────────────────────
    const startDisplay = document.getElementById('start-display');
    const endDisplay   = document.getElementById('end-display');
    const resultSec    = document.getElementById('result-section');
    const valDays      = document.getElementById('val-days');
    const valYears     = document.getElementById('val-years');
    const valMonths    = document.getElementById('val-months');
    const valCombined  = document.getElementById('val-combined');
    const badge        = document.getElementById('direction-badge');
    const swapBtn      = document.getElementById('swap-btn');
    const copyBtn      = document.getElementById('copy-btn');
    const copyLabel    = document.getElementById('copy-label');
    const navTitle     = document.querySelector('.nav-title');

    // ── Color themes ─────────────────────────────────────────────────────────
    const THEMES = [
      {
        name: 'Sky',
        '--bg-from':     '#e0e7ff', '--bg-to':       '#bae6fd',
        '--title-color': '#1e1b4b', '--card':        'rgba(255,255,255,0.92)',
        '--label':       '#1e1b4b', '--accent':      '#4f46e5',
        '--accent2':     '#0ea5e9', '--green':       '#10b981',
        '--orange':      '#f59e0b', '--combined':    '#7c3aed',
        '--separator':   'rgba(79,70,229,0.12)',
        '--swap-bg': '#4f46e5', '--copy-bg': '#0ea5e9',
      },
      {
        name: 'Rose',
        '--bg-from':     '#ffe4e6', '--bg-to':       '#fde68a',
        '--title-color': '#9f1239', '--card':        'rgba(255,255,255,0.92)',
        '--label':       '#881337', '--accent':      '#e11d48',
        '--accent2':     '#f97316', '--green':       '#16a34a',
        '--orange':      '#d97706', '--combined':    '#be185d',
        '--separator':   'rgba(225,29,72,0.12)',
        '--swap-bg': '#e11d48', '--copy-bg': '#f97316',
      },
      {
        name: 'Forest',
        '--bg-from':     '#d1fae5', '--bg-to':       '#a7f3d0',
        '--title-color': '#064e3b', '--card':        'rgba(255,255,255,0.92)',
        '--label':       '#064e3b', '--accent':      '#059669',
        '--accent2':     '#0d9488', '--green':       '#16a34a',
        '--orange':      '#ca8a04', '--combined':    '#0369a1',
        '--separator':   'rgba(5,150,105,0.12)',
        '--swap-bg': '#059669', '--copy-bg': '#0d9488',
      },
      {
        name: 'Sunset',
        '--bg-from':     '#ede9fe', '--bg-to':       '#fecdd3',
        '--title-color': '#4c1d95', '--card':        'rgba(255,255,255,0.92)',
        '--label':       '#3b0764', '--accent':      '#7c3aed',
        '--accent2':     '#db2777', '--green':       '#059669',
        '--orange':      '#ea580c', '--combined':    '#9333ea',
        '--separator':   'rgba(124,58,237,0.12)',
        '--swap-bg': '#7c3aed', '--copy-bg': '#db2777',
      },
      {
        name: 'Sand',
        '--bg-from':     '#fefce8', '--bg-to':       '#fde68a',
        '--title-color': '#78350f', '--card':        'rgba(255,255,255,0.92)',
        '--label':       '#78350f', '--accent':      '#d97706',
        '--accent2':     '#0369a1', '--green':       '#15803d',
        '--orange':      '#c2410c', '--combined':    '#b45309',
        '--separator':   'rgba(217,119,6,0.12)',
        '--swap-bg': '#d97706', '--copy-bg': '#0369a1',
      },
    ];

    let themeIndex = 0;

    function applyTheme(t) {
      const root = document.documentElement;
      Object.entries(t).forEach(([k, v]) => {
        if (k !== 'name') root.style.setProperty(k, v);
      });
      swapBtn.style.background = t['--swap-bg'];
      copyBtn.style.background = t['--copy-bg'];
    }

    applyTheme(THEMES[0]);

    // Title tap cycles theme only
    navTitle.addEventListener('click', () => {
      themeIndex = (themeIndex + 1) % THEMES.length;
      applyTheme(THEMES[themeIndex]);
    });

    // ── Date state ───────────────────────────────────────────────────────────
    // Dates stored as { y, m (1-12), d } objects; null when not set
    let startDate = null;
    let endDate   = null;

    function todayObj() {
      const n = new Date();
      return { y: n.getFullYear(), m: n.getMonth() + 1, d: n.getDate() };
    }

    function dateToStr(dt) {
      // YYYY-MM-DD internal format
      const pad = n => String(n).padStart(2, '0');
      return `${dt.y}-${pad(dt.m)}-${pad(dt.d)}`;
    }

    function strToObj(s) {
      if (!s) return null;
      const [y, m, d] = s.split('-').map(Number);
      return { y, m, d };
    }

    function fmtDisplay(dt) {
      if (!dt) return null;
      const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun',
                      'Jul','Aug','Sep','Oct','Nov','Dec'];
      return `${MONTHS[dt.m - 1]} ${dt.d}, ${dt.y}`;
    }

    function fmtCopy(dt) {
      const pad = n => String(n).padStart(2, '0');
      return `${dt.y}/${pad(dt.m)}/${pad(dt.d)}`;
    }

    function setDisplayField(which, dt) {
      const el = which === 'start' ? startDisplay : endDisplay;
      if (dt) {
        el.textContent = fmtDisplay(dt);
        el.classList.remove('placeholder');
      } else {
        el.textContent = 'Select date';
        el.classList.add('placeholder');
      }
    }

    // ── Calendar picker state ────────────────────────────────────────────────
    const calOverlay   = document.getElementById('cal-overlay');
    const calGrid      = document.getElementById('cal-grid');
    const calMonthLbl  = document.getElementById('cal-month-label');
    const calPrev      = document.getElementById('cal-prev');
    const calNext      = document.getElementById('cal-next');
    const calYearPanel = document.getElementById('cal-year-panel');
    const calCancel    = document.getElementById('cal-cancel');
    const calDone      = document.getElementById('cal-done');
    const calWeekdays  = document.getElementById('cal-weekdays');

    let calTarget    = null;   // 'start' | 'end'
    let calYear      = 2025;
    let calMonth     = 1;      // 1–12
    let calSelected  = null;   // { y, m, d } currently highlighted
    let calYearMode  = false;

    const MONTH_NAMES = ['January','February','March','April','May','June',
                         'July','August','September','October','November','December'];

    function openCalendar(which) {
      calTarget = which;
      const existing = which === 'start' ? startDate : endDate;
      const ref = existing || todayObj();
      calYear     = ref.y;
      calMonth    = ref.m;
      calSelected = existing ? { ...existing } : null;
      calYearMode = false;
      calYearPanel.classList.remove('visible');
      calGrid.style.display = '';
      calWeekdays.style.display = '';
      renderCalendar();
      calOverlay.classList.add('visible');
    }

    function renderCalendar() {
      calMonthLbl.textContent = `${MONTH_NAMES[calMonth - 1]} ${calYear}`;

      const today = todayObj();
      const firstDow = new Date(calYear, calMonth - 1, 1).getDay(); // 0=Sun
      const daysInMonth = new Date(calYear, calMonth, 0).getDate();
      const daysInPrev  = new Date(calYear, calMonth - 1, 0).getDate();

      calGrid.innerHTML = '';

      // Leading days from previous month
      for (let i = 0; i < firstDow; i++) {
        const day = daysInPrev - firstDow + 1 + i;
        const cell = document.createElement('div');
        cell.className = 'cal-day other-month';
        cell.textContent = day;
        calGrid.appendChild(cell);
      }

      // Days of current month
      for (let d = 1; d <= daysInMonth; d++) {
        const cell = document.createElement('div');
        cell.className = 'cal-day';
        cell.textContent = d;

        const isToday    = (d === today.d && calMonth === today.m && calYear === today.y);
        const isSelected = calSelected &&
                           (d === calSelected.d && calMonth === calSelected.m && calYear === calSelected.y);

        if (isToday)    cell.classList.add('today');
        if (isSelected) cell.classList.add('selected');

        cell.addEventListener('click', () => {
          calSelected = { y: calYear, m: calMonth, d };
          renderCalendar();
        });
        calGrid.appendChild(cell);
      }

      // Trailing days to fill last row
      const total = firstDow + daysInMonth;
      const trailing = total % 7 === 0 ? 0 : 7 - (total % 7);
      for (let i = 1; i <= trailing; i++) {
        const cell = document.createElement('div');
        cell.className = 'cal-day other-month';
        cell.textContent = i;
        calGrid.appendChild(cell);
      }
    }

    function renderYearPanel() {
      calYearPanel.innerHTML = '';
      const startY = 1924;
      const endY   = todayObj().y + 20;
      const years  = [];
      for (let y = startY; y <= endY; y++) years.push(y);

      // Build rows of 4
      for (let i = 0; i < years.length; i += 4) {
        const row = document.createElement('div');
        row.className = 'cal-year-row';
        for (let j = 0; j < 4 && i + j < years.length; j++) {
          const y = years[i + j];
          const btn = document.createElement('button');
          btn.className = 'cal-year-btn';
          btn.textContent = y;
          if (y === calYear) btn.classList.add('selected');
          btn.addEventListener('click', () => {
            calYear = y;
            calYearMode = false;
            calYearPanel.classList.remove('visible');
            calGrid.style.display = '';
            calWeekdays.style.display = '';
            renderCalendar();
          });
          row.appendChild(btn);
        }
        calYearPanel.appendChild(row);
      }

      // Scroll selected year into view
      requestAnimationFrame(() => {
        const sel = calYearPanel.querySelector('.cal-year-btn.selected');
        if (sel) sel.scrollIntoView({ block: 'center' });
      });
    }

    calMonthLbl.addEventListener('click', () => {
      calYearMode = !calYearMode;
      if (calYearMode) {
        calGrid.style.display = 'none';
        calWeekdays.style.display = 'none';
        calYearPanel.classList.add('visible');
        renderYearPanel();
      } else {
        calYearPanel.classList.remove('visible');
        calGrid.style.display = '';
        calWeekdays.style.display = '';
        renderCalendar();
      }
    });

    calPrev.addEventListener('click', () => {
      if (calYearMode) return;
      calMonth--;
      if (calMonth < 1) { calMonth = 12; calYear--; }
      renderCalendar();
    });

    calNext.addEventListener('click', () => {
      if (calYearMode) return;
      calMonth++;
      if (calMonth > 12) { calMonth = 1; calYear++; }
      renderCalendar();
    });

    calCancel.addEventListener('click', () => {
      calOverlay.classList.remove('visible');
    });

    calDone.addEventListener('click', () => {
      if (calSelected) {
        if (calTarget === 'start') {
          startDate = { ...calSelected };
        } else {
          endDate = { ...calSelected };
        }
        setDisplayField(calTarget, calSelected);
        updateResult();
      }
      calOverlay.classList.remove('visible');
    });

    // Tap on rows opens calendar
    document.getElementById('start-row').addEventListener('click', () => openCalendar('start'));
    document.getElementById('end-row').addEventListener('click',   () => openCalendar('end'));

    // ── Date helpers ─────────────────────────────────────────────────────────
    function dateObjToUTC(dt) {
      return new Date(Date.UTC(dt.y, dt.m - 1, dt.d));
    }

    function computeBreakdown(a, b) {
      const ua = dateObjToUTC(a), ub = dateObjToUTC(b);
      const [earlier, later] = ua <= ub ? [a, b] : [b, a];
      const ue = dateObjToUTC(earlier), ul = dateObjToUTC(later);
      const totalDays = Math.round((ul - ue) / 86_400_000);

      let cmbYears  = later.y - earlier.y;
      let cmbMonths = later.m - earlier.m;
      let cmbDays   = later.d - earlier.d;

      if (cmbDays < 0) {
        cmbMonths -= 1;
        cmbDays += new Date(Date.UTC(later.y, later.m - 1, 0)).getUTCDate();
      }
      if (cmbMonths < 0) { cmbYears -= 1; cmbMonths += 12; }

      return {
        totalDays,
        years:  Math.floor(totalDays / 365.25),
        months: Math.floor(totalDays / 30.4375),
        cmbYears, cmbMonths, cmbDays,
        reversed: ua > ub
      };
    }

    // ── Font-size auto-shrink ────────────────────────────────────────────────
    function autoShrinkFontSize() {
      const valueEls = resultSec.querySelectorAll('.result-value');
      const rows     = resultSec.querySelectorAll('.result-row');
      const MIN_SIZE = 20;
      valueEls.forEach(el => { el.style.fontSize = ''; });
      let currentSize = parseFloat(getComputedStyle(valueEls[0]).fontSize);
      function isOverflowing() {
        for (let i = 0; i < valueEls.length; i++) {
          const unitW     = rows[i].querySelector('.result-unit').offsetWidth;
          const available = rows[i].offsetWidth - unitW - 48;
          if (valueEls[i].scrollWidth > available) return true;
        }
        return false;
      }
      while (isOverflowing() && currentSize > MIN_SIZE) {
        currentSize -= 2;
        valueEls.forEach(el => { el.style.fontSize = currentSize + 'px'; });
      }
    }

    function autoShrinkCombined() {
      const el  = valCombined;
      const row = document.getElementById('row-combined');
      const MIN_SIZE = 13;
      el.style.fontSize = '';
      let currentSize = parseFloat(getComputedStyle(el).fontSize);
      while (el.scrollWidth > (row.offsetWidth - 40) && currentSize > MIN_SIZE) {
        currentSize -= 1;
        el.style.fontSize = currentSize + 'px';
      }
    }

    // ── Copy to clipboard ────────────────────────────────────────────────────
    let copyResetTimer = null;

    function copyResults() {
      const daysText     = valDays.textContent;
      const yearsText    = valYears.textContent;
      const monthsText   = valMonths.textContent;
      const combinedText = valCombined.textContent;
      if (daysText === '—') return;

      const strip = s => s.replace(/,/g, '');
      const text =
        `Start:  ${fmtCopy(startDate)}\n` +
        `End:    ${fmtCopy(endDate)}\n` +
        `\n` +
        `Days:   ${strip(daysText)}\n` +
        `Years:  ${strip(yearsText)}\n` +
        `Months: ${strip(monthsText)}\n` +
        `\n` +
        `Total:  ${combinedText}`;

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(showCopied).catch(() => fallbackCopy(text));
      } else {
        fallbackCopy(text);
      }
    }

    function fallbackCopy(text) {
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.cssText = 'position:fixed;opacity:0';
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      try { document.execCommand('copy'); showCopied(); } catch(e) {}
      document.body.removeChild(ta);
    }

    function showCopied() {
      copyBtn.classList.add('copied');
      copyLabel.textContent = 'Copied!';
      clearTimeout(copyResetTimer);
      copyResetTimer = setTimeout(() => {
        copyBtn.classList.remove('copied');
        copyBtn.style.background = THEMES[themeIndex]['--copy-bg'];
        copyLabel.textContent = 'Copy';
      }, 2000);
    }

    // ── Update results UI ────────────────────────────────────────────────────
    function updateResult() {
      if (!startDate || !endDate) {
        resultSec.classList.add('empty');
        badge.className   = 'direction-badge';
        badge.textContent = 'Select dates above';
        valDays.textContent = valYears.textContent = valMonths.textContent = '—';
        valCombined.textContent = '— Years — Months — Days';
        resultSec.querySelectorAll('.result-value').forEach(el => { el.style.fontSize = ''; });
        valCombined.style.fontSize = '';
        return;
      }

      const { totalDays, years, months, cmbYears, cmbMonths, cmbDays, reversed } =
        computeBreakdown(startDate, endDate);

      valDays.textContent   = totalDays.toLocaleString();
      valYears.textContent  = years.toLocaleString();
      valMonths.textContent = months.toLocaleString();
      valCombined.textContent =
        `${cmbYears} Year${cmbYears !== 1 ? 's' : ''} ` +
        `${cmbMonths} Month${cmbMonths !== 1 ? 's' : ''} ` +
        `${cmbDays} Day${cmbDays !== 1 ? 's' : ''}`;

      badge.className = 'direction-badge';
      if (totalDays === 0) {
        badge.textContent = 'Same day';
        badge.classList.add('same-day');
      } else if (reversed) {
        badge.textContent = 'End is before start';
        badge.classList.add('warning');
      } else {
        badge.textContent = 'start → end';
      }

      resultSec.classList.remove('empty');
      requestAnimationFrame(() => requestAnimationFrame(() => {
        autoShrinkFontSize();
        autoShrinkCombined();
      }));
    }

    // ── Swap ─────────────────────────────────────────────────────────────────
    swapBtn.addEventListener('click', () => {
      const tmp = startDate;
      startDate = endDate;
      endDate   = tmp;
      setDisplayField('start', startDate);
      setDisplayField('end',   endDate);
      updateResult();
    });

    // ── Copy ─────────────────────────────────────────────────────────────────
    copyBtn.addEventListener('click', copyResults);

    // ── Resize ───────────────────────────────────────────────────────────────
    window.addEventListener('resize', () => {
      if (!resultSec.classList.contains('empty')) {
        requestAnimationFrame(() => { autoShrinkFontSize(); autoShrinkCombined(); });
      }
    });

    // ── Touch feedback on buttons ─────────────────────────────────────────────
    [swapBtn, copyBtn].forEach(btn => {
      btn.addEventListener('touchstart', () => btn.classList.add('pressed'),   { passive: true });
      btn.addEventListener('touchend',   () => btn.classList.remove('pressed'), { passive: true });
    });

    // ── Seed both fields to today ────────────────────────────────────────────
    (function() {
      startDate = todayObj();
      endDate   = todayObj();
      setDisplayField('start', startDate);
      setDisplayField('end',   endDate);
      updateResult();
    })();

  </script>
</body>
</html>
